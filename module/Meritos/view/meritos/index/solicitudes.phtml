<div class="container-fluid">

    <!-- Page Heading -->
    <h1 class="h3 mb-2 text-gray-800">
        Solicitudes
        <?php 
        $titulos = [
            'todas' => 'de Méritos Curriculares',
            'premios' => '- Premios y Reconocimientos',
            'investigaciones' => '- Investigaciones y Publicaciones',
            'formacion' => '- Formación Académica',
            'cargos' => '- Cargos Desempeñados',
            'capacitacion' => '- Capacitación Profesional'
        ];
        $categoriaActual = isset($this->categoriaActual) ? $this->categoriaActual : 'todas';
        echo $titulos[$categoriaActual] ?? 'de Méritos Curriculares';
        ?>
    </h1>

    <div class="modal fade" id="modalPdf" tabindex="-1" aria-labelledby="modalPdf" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Ver constancia</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeModal()">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <iframe id="iframePDF" frameborder="0" scrolling="no" width="100%" height="500px"></iframe>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeModal()">Cerrar</button>
                    </div>
                </div>
            </div>
    </div>

    <!-- DataTales Example -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="row align-items-center">
                <div class="col">
                    <h6 class="m-0 font-weight-bold text-primary">Solicitudes de Meritos curriculares</h6>
                </div>
                <div class="col-auto">
                    <div class="small text-muted">
                        <?php
                        // Contar por estados
                        $contadores = ['Ingresada' => 0, 'Aceptada' => 0, 'Rechazada' => 0, 'Ingresada - Límite Alcanzado' => 0, 'Ingresada - Sin Efecto' => 0];
                        
                        foreach ([$this->premios, $this->cargos, $this->formacion, $this->capacitacion, $this->investigaciones] as $categoria) {
                            foreach ($categoria as $item) {
                                if (isset($contadores[$item['nombre_estado']])) {
                                    $contadores[$item['nombre_estado']]++;
                                }
                            }
                        }
                        ?>
                        <span class="badge badge-info me-1">Ingresadas: <?= $contadores['Ingresada'] ?></span>
                        <span class="badge badge-success me-1">Aceptadas: <?= $contadores['Aceptada'] ?></span> 
                        <span class="badge badge-danger me-1">Rechazadas: <?= $contadores['Rechazada'] ?></span>
                        <?php if ($contadores['Ingresada - Límite Alcanzado'] > 0): ?>
                            <span class="badge badge-secondary me-1">Límite Alcanzado: <?= $contadores['Ingresada - Límite Alcanzado'] ?></span>
                        <?php endif; ?>
                        <?php if ($contadores['Ingresada - Sin Efecto'] > 0): ?>
                            <span class="badge badge-dark">Sin Efecto: <?= $contadores['Ingresada - Sin Efecto'] ?></span>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- FILTRO POR ESTADO CON BOTÓN BUSCAR -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="estadoFilter" class="form-label">Filtrar por estado:</label>
                    <select id="estadoFilter" class="form-control">
                        <option value="Ingresada" selected>Ingresadas</option>
                        <option value="Aceptada">Aceptadas</option>
                        <option value="Rechazada">Rechazadas</option>
                        <option value="Ingresada - Límite Alcanzado">Límite Alcanzado</option>
                        <option value="Ingresada - Sin Efecto">Sin Efecto</option>
                        <option value="">Todos los estados</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" id="btnBuscar" class="btn btn-primary">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped dtable" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Fecha de solicitud</th>
                            <th>Nombre docente</th>
                            <th>Grado academico</th>
                            <th>Tipo de solicitud</th>
                            <th>Constancia</th>
                            <th>Estado solicitud</th>
                            <th>Puntaje asignado</th>
                            <th>Info Puntajes</th>
                            <th>Ver detalles de la solicitud</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($this->premios as $tmp): ?>
                            <tr>
                                <td><?= $tmp["created_at"] ?></td>
                                <td><?= $tmp["nombre"] ?></td>
                                <td><?= $tmp["grado_academico"] ?></td>
                                <td>Premios, menciones honoríficas y reconocimientos a nivel profesional</td>
                                <td> 
                                    <a class="btn btn-primary" href="<?= $this->url("meritosHome/meritos", ["action" => "displayfile" , "val1"=> $tmp['url_file']]) ?>" target="_blank">
                                        Constancia
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-<?= $tmp["color"] ?>" 
                                          data-toggle="tooltip" 
                                          title="<?= $tmp["tooltip"] ?? '' ?>">
                                        <?= $tmp["nombre_estado"] ?>
                                    </span>
                                </td>
                                <td><?= $tmp["puntos"] ?></td>
                                <td>
                                    <small>
                                        <strong>Categoría:</strong> <?= $tmp['puntaje_categoria_actual'] ?? 0 ?>/<?= $tmp['limite_categoria'] ?? 2 ?><br>
                                        <strong>Total:</strong> <?= $tmp['puntaje_total_actual'] ?? 0 ?>/30
                                        
                                        <?php if (($tmp['categoria_limite_alcanzado'] ?? false)): ?>
                                            <br><span class="text-success">✅ Límite de categoría alcanzado</span>
                                        <?php endif; ?>
                                        
                                        <?php if (($tmp['limite_total_alcanzado'] ?? false)): ?>
                                            <br><span class="text-warning">⚠️ Límite total alcanzado</span>
                                        <?php endif; ?>
                                    </small>
                                </td>
                                <td>
                                    <a class="btn btn-primary btn-sm1" href="<?= $this->url("meritosHome/meritos", ["action" => "admPremios" , "val1"=> "edit", "val2"=>$tmp["id_premio"]]) ?>">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        <?php foreach ($this->cargos as $tmp): ?>
                            <tr>
                                <td><?= $tmp["created_at"] ?></td>
                                <td><?= $tmp["nombre"] ?></td>
                                <td><?= $tmp["grado_academico"] ?></td>
                                <td>Cargos desempeñados</td>
                                <td> 
                                    <a class="btn btn-primary" href="<?= $this->url("meritosHome/meritos", ["action" => "displayfile" , "val1"=> $tmp['url_constancia']]) ?>" target="_blank">
                                        Constancia
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-<?= $tmp["color"] ?>" 
                                          data-toggle="tooltip" 
                                          title="<?= $tmp["tooltip"] ?? '' ?>">
                                        <?= $tmp["nombre_estado"] ?>
                                    </span>
                                </td>
                                <td><?= $tmp["puntos"] ?></td>
                                <td>
                                    <small>
                                        <strong>Categoría:</strong> <?= $tmp['puntaje_categoria_actual'] ?? 0 ?>/<?= $tmp['limite_categoria'] ?? 4 ?><br>
                                        <strong>Total:</strong> <?= $tmp['puntaje_total_actual'] ?? 0 ?>/30
                                        
                                        <?php if (($tmp['categoria_limite_alcanzado'] ?? false)): ?>
                                            <br><span class="text-success">✅ Límite de categoría alcanzado</span>
                                        <?php endif; ?>
                                        
                                        <?php if (($tmp['limite_total_alcanzado'] ?? false)): ?>
                                            <br><span class="text-warning">⚠️ Límite total alcanzado</span>
                                        <?php endif; ?>
                                    </small>
                                </td>
                                <td>
                                    <a class="btn btn-primary btn-sm1" href="<?= $this->url("meritosHome/meritos", ["action" => "admCargos" , "val1"=> "edit", "val2"=>$tmp["id_cargo"]]) ?>">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        <?php foreach ($this->formacion as $tmp): ?>
                            <tr>
                                <td><?= $tmp["created_at"] ?></td>
                                <td><?= $tmp["nombre"] ?></td>
                                <td><?= $tmp["grado_academico"] ?></td>
                                <td>Formación profesional</td>
                                <td> 
                                    <a class="btn btn-primary" href="<?= $this->url("meritosHome/meritos", ["action" => "displayfile" , "val1"=> $tmp['url_constancia']]) ?>" target="_blank">
                                        Constancia
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-<?= $tmp["color"] ?>" 
                                          data-toggle="tooltip" 
                                          title="<?= $tmp["tooltip"] ?? '' ?>">
                                        <?= $tmp["nombre_estado"] ?>
                                    </span>
                                </td>
                                <td><?= $tmp["puntos"] ?></td>
                                <td>
                                    <small>
                                        <strong>Categoría:</strong> <?= $tmp['puntaje_categoria_actual'] ?? 0 ?>/<?= $tmp['limite_categoria'] ?? 10 ?><br>
                                        <strong>Total:</strong> <?= $tmp['puntaje_total_actual'] ?? 0 ?>/30
                                        
                                        <?php if (($tmp['categoria_limite_alcanzado'] ?? false)): ?>
                                            <br><span class="text-success">✅ Límite de categoría alcanzado</span>
                                        <?php endif; ?>
                                        
                                        <?php if (($tmp['limite_total_alcanzado'] ?? false)): ?>
                                            <br><span class="text-warning">⚠️ Límite total alcanzado</span>
                                        <?php endif; ?>
                                    </small>
                                </td>
                                <td>
                                    <a class="btn btn-primary btn-sm1" href="<?= $this->url("meritosHome/meritos", ["action" => "admFormacionAcademica" , "val1"=> "edit", "val2"=>$tmp["id_formacion_academica"]]) ?>">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>

                        <?php foreach ($this->capacitacion as $tmp): ?>
                            <tr>
                                <td><?= $tmp["created_at"] ?></td>
                                <td><?= $tmp["nombre"] ?></td>
                                <td><?= $tmp["grado_academico"] ?></td>
                                <td>Capacitación profesional: Relacionada con la docencia</td>
                                <td> 
                                    <a class="btn btn-primary" href="<?= $this->url("meritosHome/meritos", ["action" => "displayfile" , "val1"=> $tmp['url_constancia']]) ?>" target="_blank">
                                        Constancia
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-<?= $tmp["color"] ?>" 
                                          data-toggle="tooltip" 
                                          title="<?= $tmp["tooltip"] ?? '' ?>">
                                        <?= $tmp["nombre_estado"] ?>
                                    </span>
                                </td>
                                <td><?= $tmp["puntos"] ?></td>
                                <td>
                                    <small>
                                        <strong>Categoría:</strong> <?= $tmp['puntaje_categoria_actual'] ?? 0 ?>/<?= $tmp['limite_categoria'] ?? 8 ?><br>
                                        <strong>Total:</strong> <?= $tmp['puntaje_total_actual'] ?? 0 ?>/30
                                        
                                        <?php if (($tmp['categoria_limite_alcanzado'] ?? false)): ?>
                                            <br><span class="text-success">✅ Límite de categoría alcanzado</span>
                                        <?php endif; ?>
                                        
                                        <?php if (($tmp['limite_total_alcanzado'] ?? false)): ?>
                                            <br><span class="text-warning">⚠️ Límite total alcanzado</span>
                                        <?php endif; ?>
                                    </small>
                                </td>
                                <td>
                                    <a class="btn btn-primary btn-sm1" href="<?= $this->url("meritosHome/meritos", ["action" => "admCapacitacionProfesional" , "val1"=> "edit", "val2"=>$tmp["id_capacitacion"]]) ?>">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                        <?php foreach ($this->investigaciones as $tmp): ?>
                            <tr>
                                <td><?= $tmp["created_at"] ?></td>
                                <td><?= $tmp["nombre"] ?></td>
                                <td><?= $tmp["grado_academico"] ?></td>
                                <td>Investigaciones y/o publicaciones realizadas</td>
                                <td> 
                                    <a class="btn btn-primary" href="<?= $this->url("meritosHome/meritos", ["action" => "displayfile" , "val1"=> $tmp['url_constancia']]) ?>" target="_blank">
                                        Constancia
                                    </a>
                                </td>
                                <td>
                                    <span class="badge badge-<?= $tmp["color"] ?>" 
                                          data-toggle="tooltip" 
                                          title="<?= $tmp["tooltip"] ?? '' ?>">
                                        <?= $tmp["nombre_estado"] ?>
                                    </span>
                                </td>
                                <td><?= $tmp["puntos"] ?></td>
                                <td>
                                    <small>
                                        <strong>Categoría:</strong> <?= $tmp['puntaje_categoria_actual'] ?? 0 ?>/<?= $tmp['limite_categoria'] ?? 6 ?><br>
                                        <strong>Total:</strong> <?= $tmp['puntaje_total_actual'] ?? 0 ?>/30
                                        
                                        <?php if (($tmp['categoria_limite_alcanzado'] ?? false)): ?>
                                            <br><span class="text-success">✅ Límite de categoría alcanzado</span>
                                        <?php endif; ?>
                                        
                                        <?php if (($tmp['limite_total_alcanzado'] ?? false)): ?>
                                            <br><span class="text-warning">⚠️ Límite total alcanzado</span>
                                        <?php endif; ?>
                                    </small>
                                </td>
                                <td>
                                    <a class="btn btn-primary btn-sm1" href="<?= $this->url("meritosHome/meritos", ["action" => "admInvestigaciones" , "val1"=> "edit", "val2"=>$tmp["id_investigacion"]]) ?>">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<?php
$this->headScript()->appendScript('
    $(document).ready(function() {

        // Inicializar tooltips de Bootstrap
        $("[data-toggle=\"tooltip\"]").tooltip();

        // Configuración de idioma español local
        var configuracionEspanol = {
            "decimal": ",",
            "emptyTable": "No hay datos disponibles en la tabla",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
            "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
            "infoFiltered": "(filtrado de _MAX_ entradas totales)",
            "infoPostFix": "",
            "thousands": ".",
            "lengthMenu": "Mostrar _MENU_ entradas",
            "loadingRecords": "Cargando...",
            "processing": "Procesando...",
            "search": "Buscar:",
            "zeroRecords": "No se encontraron registros coincidentes",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            },
            "aria": {
                "sortAscending": ": activar para ordenar la columna ascendente",
                "sortDescending": ": activar para ordenar la columna descendente"
            }
        };

        // Verificar si hay filas en el HTML ANTES de inicializar DataTable
        var filasEnHTML = $("#dataTable tbody tr").length;
        var table;

        // Reinicializar DataTable con stateSave para asegurar que se guarden buscador y filtros
        if ($.fn.DataTable.isDataTable("#dataTable")) {
            $("#dataTable").DataTable().destroy();
        }
        
        table = $("#dataTable").DataTable({
            "language": configuracionEspanol,
            "order": [[1, "asc"], [0, "desc"]],
            "pageLength": 25,
            "responsive": true,
            "stateSave": true
        });

        // Verificar estado final
        var filasFinales = table.rows().count();
        
        if (filasFinales > 0) {
            
            // Sincronizar el filtro de estado con el estado guardado de DataTables
            var state = table.state.loaded();
            if (state && state.columns && state.columns[5] && state.columns[5].search) {
                // Sincronizar el select con el valor guardado (aunque sea cadena vacía para "Todos")
                $("#estadoFilter").val(state.columns[5].search.search);
            } else if (!state) {
                // Solo si es una carga limpia (sin estado previo), aplicar filtro inicial "Ingresada"
                table.column(5).search("Ingresada", false, false).draw();
                $("#estadoFilter").val("Ingresada");
            }
                    
            // Event listener para el botón Buscar
            $("#btnBuscar").off("click").on("click", function () {
                var estadoSeleccionado = $("#estadoFilter").val();
                
                // Limpiar filtros anteriores de columnas (manteniendo el buscador general si se desea, 
                // pero aquí parece que se quiere una búsqueda limpia por estado)
                table.columns().search("").draw();
                
                // Aplicar nuevo filtro si hay selección
                if (estadoSeleccionado) {
                    table.column(5).search(estadoSeleccionado, false, false);
                }
                
                // Ordenar según el filtro aplicado
                if (estadoSeleccionado === "Ingresada") {
                    table.order([[1, "asc"], [0, "desc"]]).draw();
                } else {
                    table.order([[0, "desc"]]).draw();
                }
            });

            $("#estadoFilter").off("keypress").on("keypress", function(e) {
                if (e.which === 13) {
                    $("#btnBuscar").click();
                }
            });
        } else {
            console.warn("No se pudo inicializar la tabla con datos - Verificando HTML...");
            
            if (filasEnHTML === 0) {
                $("#dataTable tbody").html("<tr><td colspan=\"8\" class=\"text-center text-muted\"><i class=\"fas fa-info-circle\"></i> No hay solicitudes para mostrar en este momento</td></tr>");
            }
        }
    });

    function closeModal() {
        $("#modalPdf").modal("hide");
    }
    ');
?>